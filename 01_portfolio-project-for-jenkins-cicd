pipeline {
    // âœ… Define where the pipeline should run
    agent { label 'my-remote-server' } 
    // 'my-remote-server' is the label of the Jenkins agent/node where this pipeline will execute

    stages {

        // ================================
        stage ('Code') {
            // ğŸ”¹ Stage 1: Pull source code from GitHub
            steps {
                echo 'code is pulling...'

                // ğŸ”¹ Pull code from the 'main' branch of the specified GitHub repository
                git branch: 'main', url: 'https://github.com/shivamFullStack111/portfolio-project-for-jenkins-cicd'

                echo 'code pull successful...'
            }
        }

        // ================================
        stage ('Build') {
            // ğŸ”¹ Stage 2: Build Docker image from the pulled code
            steps {
                echo 'code is building...'

                // ğŸ”¹ Build the Docker image using the Dockerfile in the current directory
                // ğŸ”¹ Tag the image as: shivamfullstack111/new-portfolio-project:latest
                sh 'docker build -t shivamfullstack111/new-portfolio-project:latest .'

                echo 'code build successful...'
            }
        }

        // ================================
        stage ('Push') {
            // ğŸ”¹ Stage 3: Push Docker image to Docker Hub
            steps {
                echo 'Image is uploading to Docker Hub...'

                // ğŸ” Securely fetch DockerHub credentials from Jenkins Credentials Store
                withCredentials([usernamePassword(
                    credentialsId: 'Docker-Credentail',     // ID of the DockerHub credentials stored in Jenkins
                    usernameVariable: 'DOCKER_USER',        // Runtime variable to store username
                    passwordVariable: 'DOCKER_PASS'         // Runtime variable to store password
                )]) {
                    // ğŸ” Perform Docker login using the credentials
                    sh 'docker login -u "$DOCKER_USER" -p "$DOCKER_PASS"'

                    // ğŸ”¼ Push the built Docker image to DockerHub
                    sh 'docker push shivamfullstack111/new-portfolio-project:latest'
                }

                echo 'Image pushed successfully...'
            }
        }

        // ================================
        stage ("Deploy") {
            // ğŸ”¹ Stage 4: Deploy the Docker container
            steps {
                echo 'Deploying...'

                // ğŸƒ Run the Docker container in detached mode, exposing port 5173
                // -d: Run container in background
                // -p 5173:5173 â†’ maps host port 5173 to container port 5173
                sh 'docker run -d -p 5173:5173 shivamfullstack111/new-portfolio-project:latest'

                echo 'Deploy success...'
            }
        }
    }
}
